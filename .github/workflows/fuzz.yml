name: Continuous Fuzzing

on:
  pull_request:
  push:
    branches: [main]
  schedule:
    - cron: '0 2 * * *'  # Nightly fuzzing

jobs:
  fuzz-quick:
    name: Quick Fuzz Tests (PR/Push)
    runs-on: ubuntu-latest
    if: github.event_name != 'schedule'
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-go@v5
        with:
          go-version: '1.25'
      - name: Run quick fuzz tests
        run: make fuzz
      - name: Upload crash artifacts
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: fuzz-crashes
          path: '**/testdata/fuzz/**/crash-*'

  fuzz-extended:
    name: Extended Fuzzing (Nightly)
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule'
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-go@v5
        with:
          go-version: '1.25'
      - name: Restore fuzz corpus
        uses: actions/cache@v4
        with:
          path: '**/testdata/fuzz'
          key: fuzz-corpus-${{ hashFiles('**/*_fuzz_test.go') }}-${{ github.run_id }}
          restore-keys: |
            fuzz-corpus-${{ hashFiles('**/*_fuzz_test.go') }}-
            fuzz-corpus-
      - name: Run nightly fuzz tests
        run: make fuzz-nightly
      - name: Upload crash artifacts
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: fuzz-crashes-nightly
          path: '**/testdata/fuzz/**/crash-*'
      - name: Create issue if crashes found
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'Fuzzing found crashes in nightly run',
              body: 'Extended fuzzing discovered input that causes crashes. Check artifacts for details.',
              labels: ['bug', 'security', 'fuzzing']
            })
