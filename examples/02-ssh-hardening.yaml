# SSH Hardening (SOC2 CC6.1)
# Run: reglet check examples/02-ssh-hardening.yaml
#
# This profile implements SOC2 control CC6.1 - Logical and Physical Access Controls
# Specifically focused on SSH configuration hardening
#
# NOTE: This requires /etc/ssh/sshd_config to exist on the system

profile:
  name: SSH Configuration Hardening
  description: SOC2 control CC6.1 - SSH security baseline
  version: 1.0.0
  references:
    - name: SOC2 CC6.1
      url: https://www.aicpa.org/soc4so

controls:
  - id: soc2-cc6.1-ssh-config-exists
    name: SSH configuration file exists
    description: Verify sshd_config is present
    severity: critical
    tags: [soc2, ssh, config]
    observations:
      - plugin: file
        config:
          path: /etc/ssh/sshd_config
        expect: |
          data.exists && !data.is_dir

  - id: soc2-cc6.1-ssh-config-permissions
    name: SSH config has restrictive permissions
    description: sshd_config should only be writable by root
    severity: high
    tags: [soc2, ssh, permissions]
    observations:
      - plugin: file
        config:
          path: /etc/ssh/sshd_config
        expect: |
          data.exists &&
          (data.mode == "0600" || data.mode == "0644")

  - id: soc2-cc6.1-ssh-password-auth
    name: SSH password authentication disabled
    description: Password authentication should be disabled in favor of key-based auth
    severity: high
    tags: [soc2, ssh, authentication]
    observations:
      - plugin: file
        config:
          path: /etc/ssh/sshd_config
        expect: |
          data.content.contains("PasswordAuthentication no")

  - id: soc2-cc6.1-ssh-root-login
    name: SSH root login disabled or restricted
    description: Direct root login should be prohibited or limited to keys only
    severity: critical
    tags: [soc2, ssh, privileged-access]
    observations:
      - plugin: file
        config:
          path: /etc/ssh/sshd_config
        expect: |
          data.content.contains("PermitRootLogin no") ||
          data.content.contains("PermitRootLogin prohibit-password") ||
          data.content.contains("PermitRootLogin without-password")

  - id: soc2-cc6.1-ssh-protocol-version
    name: SSH protocol version 2 enforced
    description: Only SSH protocol version 2 should be allowed (v1 is insecure)
    severity: high
    tags: [soc2, ssh, protocol]
    observations:
      - plugin: file
        config:
          path: /etc/ssh/sshd_config
        expect: |
          !data.content.contains("Protocol 1")

  - id: soc2-cc6.1-ssh-empty-passwords
    name: Empty passwords forbidden
    description: Connections with empty passwords must be denied
    severity: critical
    tags: [soc2, ssh, authentication]
    observations:
      - plugin: file
        config:
          path: /etc/ssh/sshd_config
        expect: |
          data.content.contains("PermitEmptyPasswords no") ||
          !data.content.contains("PermitEmptyPasswords yes")

  - id: soc2-cc6.1-ssh-x11-forwarding
    name: X11 forwarding disabled (optional)
    description: X11 forwarding can be a security risk if not needed
    severity: low
    tags: [soc2, ssh, hardening]
    observations:
      - plugin: file
        config:
          path: /etc/ssh/sshd_config
        expect: |
          data.content.contains("X11Forwarding no") ||
          !data.content.contains("X11Forwarding yes")
