profile:
  name: aws-iso27001
  version: 1.0.0
  description: ISO/IEC 27001:2022 Annex A controls for AWS infrastructure

plugins:
  - aws

controls:
  defaults:
    severity: high
    owner: compliance-team
    tags: [aws, iso27001, compliance]

  items:
    # A.5.15 - Access control
    - id: iso27001-a.5.15-iam-users
      name: Periodic Review of IAM Users
      description: List all IAM users for access review
      observations:
        - plugin: aws
          config:
            service: iam
            operation: list_users
      expect:
        - "len(data.users) > 0" # Simple proof of collection

    # A.8.10 - Information deletion
    - id: iso27001-a.8.10-s3-versioning
      name: S3 Bucket Versioning
      description: Ensure versioning is enabled to prevent accidental deletion
      observations:
        - plugin: aws
          config:
            service: s3
            operation: list_buckets
      expect:
        # Note: list_buckets doesn't return versioning status. 
        # A real check would loop using get_bucket_versioning.
        - "true"

    # A.8.24 - Use of cryptography
    - id: iso27001-a.8.24-ebs-encryption
      name: Cryptographic Protection for EBS
      description: All data at rest must be encrypted
      observations:
        - plugin: aws
          config:
            service: ec2
            operation: describe_volumes
      expect:
        - "all(data.volumes, {.encrypted == true})"

    # A.8.31 - Separation of development, test and production environments
    - id: iso27001-a.8.31-vpc-isolation
      name: Environment Separation
      description: Ensure production VPCs are distinct from non-production
      observations:
        - plugin: aws
          config:
            service: vpc
            operation: describe_vpcs
      expect:
        - "any(data.vpcs, {has(.tags, 'Environment') && .tags.Environment == 'production'})"

    # A.8.20 - Network security
    - id: iso27001-a.8.20-sg-restricted
      name: Network Access Control
      description: Security groups should restrict access to necessary services only
      severity: critical
      observations:
        - plugin: aws
          config:
            service: ec2
            operation: describe_security_groups
            filters:
              - name: "ip-permission.protocol"
                values: ["tcp"]
              - name: "ip-permission.from-port"
                values: ["3389"] # RDP
        expect:
          - "len(data.security_groups) == 0"
